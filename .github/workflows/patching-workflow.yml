name: Patching Workflow (Mock)

on:
  workflow_dispatch:
  push:
    paths:
      - "projects/hosts.ini"
      - "projects/patching-workflow/**"
      - ".github/workflows/patching-workflow.yml"

jobs:
  patching-mock:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Generate mock fixtures from projects/hosts.ini
        working-directory: projects/patching-workflow
        shell: bash
        run: |
          set -euo pipefail

          rm -rf fixtures
          mkdir -p fixtures

          # Extract hostnames (skip comments, blanks, and [groups])
          HOSTS=$(grep -vE '^\s*#|^\s*$|^\s*\[.*\]\s*$' ../hosts.ini)

          for h in $HOSTS; do
            d="fixtures/${h}"
            mkdir -p "$d"

            # Keep runs GREEN for portfolio: rc=0 everywhere.
            # Add variety so output isn't boring.
            if [[ "$h" == *proxy* ]]; then
              printf '%s' '{"rc":0,"updated":["agent"],"installed":[],"msg":"mock patch succeeded"}' > "${d}/yum_result.json"
            elif [[ "$h" == *worker* ]]; then
              printf '%s' '{"rc":0,"updated":["worker-utils"],"installed":[],"msg":"mock patch succeeded"}' > "${d}/yum_result.json"
            else
              printf '%s' '{"rc":0,"updated":["core-utils"],"installed":[],"msg":"mock patch succeeded"}' > "${d}/yum_result.json"
            fi
          done

      - name: Run mock patch playbook
        working-directory: projects/patching-workflow
        env:
          ANSIBLE_CONFIG: ansible.cfg
          RUN_ID: mock-${{ github.run_id }}
        run: |
          # No --tags apply here: ensures the report play runs too.
          ansible-playbook -i ../hosts.ini patch_mock.yml -e target=all -e run_id="$RUN_ID"

      - name: Publish run report to workflow summary
        shell: bash
        env:
          RUN_ID: mock-${{ github.run_id }}
        run: |
          echo "## Patching Workflow (Mock) â€” Run Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Helpful if something goes wrong
          echo "**Report path:** projects/patching-workflow/artifacts/${RUN_ID}/patch-report.txt" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat "projects/patching-workflow/artifacts/${RUN_ID}/patch-report.txt" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: patching-workflow-mock-artifacts
          path: projects/patching-workflow/artifacts/
